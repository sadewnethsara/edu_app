# Debug Past Papers Collection

## What Changed

Added comprehensive debugging to understand the exact structure of your `pastPapers` collection in Firestore.

## New Features

### 1. Debug Method
`ApiService.debugPastPapersCollection()` - Shows exactly what's in your database:
- Document IDs
- All field names
- Field values for first 10 papers

### 2. Fallback Query Method
`ApiService.getAllPastPapersForGrade()` - Alternative fetching approach:
- Fetches ALL papers from collection
- Filters in memory by subject and language
- Used automatically if main query returns empty

### 3. Auto-Debug on Load
The Past Papers screen now automatically runs debug on first load to show database contents.

## How to Debug

### Step 1: Run the App
```bash
flutter run
```

### Step 2: Open Past Papers Screen
Navigate to Past Papers from the menu.

### Step 3: Check Console Logs

You should see:

**Database Structure:**
```
üîç DEBUG: Checking pastPapers collection...
DEBUG: Found X documents
DEBUG Paper:
  ID: abc123
  Title: 2023 Final Exam
  SubjectId: mathematics
  Year: 2023
  Language: english
  FileUrl: https://...
  UploadedAt: 2024-11-11T...
  All fields: title, year, subjectId, language, fileUrl, ...
```

**Query Results:**
```
üìö Fetching past papers for grade: grade_6, language: en
Found X subjects for grade grade_6
Fetching papers for subject: Mathematics (mathematics)
Found X papers for subject Mathematics
‚úÖ Total papers loaded: X for grade grade_6
```

**Fallback (if needed):**
```
‚ö†Ô∏è No papers found with subject-based query, trying fallback method...
üîç Fetching ALL past papers, will filter by grade: grade_6
üì¶ Found X total papers in database
Subject IDs for grade grade_6: {mathematics, science, ...}
All papers from DB: ...
‚úÖ Filtered to X papers for grade grade_6, language en
```

## Expected Database Structure

Based on admin panel code, each document should have:

```javascript
{
  // Document ID: auto-generated by Firestore
  
  // Required fields:
  "title": "2023 Final Exam",
  "year": "2023",              // String, not number
  "subjectId": "mathematics",  // CRITICAL: Must match subject ID in grade
  "language": "english",       // Full word: "english" or "sinhala"
  "fileUrl": "https://...",
  
  // Optional fields:
  "term": "Term 3",
  "description": "Final examination paper",
  "fileSize": 1024000,
  "tags": ["algebra", "geometry"],
  "uploadedAt": "2024-11-11T10:00:00Z",
  "uploadedBy": "admin_uid"
}
```

## Troubleshooting

### Issue 1: Field Names Don't Match

**Check the debug output for "All fields:"**

If you see different field names (e.g., `subject_id` instead of `subjectId`), you need to update the code to match.

**Example Fix:**
```dart
'subjectId': data['subject_id'] ?? subject.id,  // Use underscore version
```

### Issue 2: No SubjectId Field

If papers don't have `subjectId`:

**Option A:** Add `subjectId` to existing papers in Firestore
**Option B:** Use a different field (check debug output for available fields)
**Option C:** Use the `getAllPastPapersForGrade()` fallback without subject filtering

### Issue 3: Language Mismatch

Check debug output for how language is stored:
- If you see `"lang": "en"` instead of `"language": "english"`
- Update the mapping in `PastPaperModel.fromJson()`

### Issue 4: Wrong Collection Name

If the collection isn't called `pastPapers`:

**Check Firebase Console** ‚Üí Firestore Database ‚Üí Collections

**Update code:**
```dart
.collection('past_papers')  // or whatever your collection is named
```

### Issue 5: Papers Show But Wrong Language

Check that papers have the correct language value:
- Should be "english" or "sinhala" (lowercase)
- NOT "en" or "si" in Firestore
- The app converts "en" ‚Üí "english" for queries

## Next Steps After Debugging

### 1. Analyze Debug Output
Look at the "All fields:" line in the debug output to see exact field names.

### 2. Compare with Expected Structure
Check if your database matches the expected structure above.

### 3. Update Code If Needed
If field names are different, update the `fromJson` mapping in `api_service.dart`.

### 4. Test Fallback Method
If subject-based queries don't work, the fallback method will try automatically.

### 5. Check Subject IDs Match
Ensure papers' `subjectId` matches subjects in:
```
/curricula/{language}/grades/{gradeId}/subjects/{subjectId}
```

## Manual Testing Queries

You can also test directly in Firebase Console:

### Query 1: Get All Papers
```
Collection: pastPapers
```

### Query 2: Papers by Subject
```
Collection: pastPapers
Where: subjectId == mathematics
```

### Query 3: Papers by Language
```
Collection: pastPapers
Where: language == english
```

## Quick Fixes

### If papers exist but don't show:

1. **Check subject IDs match:**
   - Papers: `subjectId: "mathematics"`
   - Subjects collection: has document with ID `"mathematics"`

2. **Check language format:**
   - Papers should have `language: "english"` or `language: "sinhala"`
   - NOT `lang`, `medium`, or other field names

3. **Check collection name:**
   - Must be exactly `pastPapers` (camelCase)
   - NOT `past_papers`, `PastPapers`, or `pastpapers`

4. **Run the app and look for:**
   - `DEBUG Paper:` lines showing your actual data
   - Any error messages
   - The fallback method activating

## Summary

The code now has three approaches to fetch papers:

1. **Subject-based query** (primary) - Fast, uses Firestore indexes
2. **Fallback query** (automatic) - Fetches all, filters in memory
3. **Debug method** (diagnostic) - Shows exactly what's in database

Run the app and check the console - it will tell you exactly what's happening! üîç
